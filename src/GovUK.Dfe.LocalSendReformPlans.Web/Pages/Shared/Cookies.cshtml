@page "/Cookies"
@using GovUk.Frontend.AspNetCore
@using Microsoft.AspNetCore.Http.Features;
@using Microsoft.AspNetCore.Http;
@model GovUK.Dfe.LocalSendReformPlans.Web.Pages.Shared.CookiesModel;

@{
    ViewData["Title"] = "Cookies";

    var consentFeature = this.HttpContext.Features.Get<ITrackingConsentFeature>();
    var canTrack = consentFeature?.CanTrack ?? false;
}

@{
    var cookieSaved = (bool)(TempData["cookiePreferenceSaved"] ?? false);
    var returnPath = (string?)TempData["returnPath"];
}

@if (cookieSaved)
{
    <govuk-notification-banner type="NotificationBannerType.Success">
        <p class="govuk-notification-banner__heading">
            You’ve set your cookie preferences. 
            @{if(!string.IsNullOrWhiteSpace(returnPath) && returnPath != "/Cookies")
                {
                    <a class="govuk-notification-banner__link" href="@TempData["returnPath"]"> Go back to the page you were looking at.</a>
                }
            }
        </p>
    </govuk-notification-banner>
}


<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-xl">Cookies</h1>
        <p class="govuk-body">Cookies are small files saved on your phone, tablet or computer when you visit a website.</p>
        <p class="govuk-body">We use cookies to make this service work and collect information about how you use our service.</p>
        <h2 class="govuk-heading-m">Essential cookies</h2>
        <p class="govuk-body">Essential cookies keep your information secure while you use Apply to transfer an academy into your trust. We do not need to ask permission to use them.</p>
        <table class="govuk-table">
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Name</th>
                    <th scope="col" class="govuk-table__header">Purpose</th>
                    <th scope="col" class="govuk-table__header">Expires</th>
                </tr>
            </thead>
            <tbody class="govuk-table__body">
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">.AspNetCore.Antiforgery</td>
                    <td class="govuk-table__cell">Cross-Site Request Forgery prevention. This cookie ensures that your activity originated from this site.</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">.AspNetCore.Session</td>
                    <td class="govuk-table__cell">Stores any relevant data for your session</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">.AspNet.Consent</td>
                    <td class="govuk-table__cell">Cookie consent preference</td>
                    <td class="govuk-table__cell">1 year</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">.AspNet.Cookies</td>
                    <td class="govuk-table__cell">Stores authentication details for the logged in user</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">.AspNetCore.Mvc.Cookies<br />.CookieTempDataProvider</td>
                    <td class="govuk-table__cell">Stores temporary data for the session</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">
                        ASLBSACORS and ASLBSA
                    </td>
                    <td class="govuk-table__cell">Used by Microsoft's Azure Front Door service to determine the best server to respond to users' requests based on their location</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">hubauth</td>
                    <td class="govuk-table__cell">Authenticates your connection to our real-time notification service. This ensures you receive updates (like application progress) securely without refreshing the page.</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
            </tbody>
        </table>
        <h2 class="govuk-heading-m">Analytics cookies (optional)</h2>
        <h3 class="govuk-heading-s">Azure Application Insights</h3>
        <p class="govuk-body">We use Azure Application Insights software to collect information about how you use this website. We do this to help make sure the site is meeting the needs of its users and to help us make improvements.</p>
        <p class="govuk-body">Azure Application Insights stores information about:</p>
        <ul class="govuk-list govuk-list--bullet">
            <li>the pages you visit on this website</li>
            <li>how long you spend on each page</li>
            <li>what you click on while you're visiting the site</li>
        </ul>
        <p class="govuk-body">We don't allow Microsoft to use or share our analytics data.</p>
        <p class="govuk-body">Azure Application Insights sets the following cookies:</p>
        <table class="govuk-table">
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    <th scope="col" class="govuk-table__header">Name</th>
                    <th scope="col" class="govuk-table__header">Purpose</th>
                    <th scope="col" class="govuk-table__header">Expires</th>
                </tr>
            </thead>
            <tbody class="govuk-table__body">
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">ai_session</td>
                    <td class="govuk-table__cell">This helps us track activity happening over a single browser session</td>
                    <td class="govuk-table__cell">1 hour</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">ai_user</td>
                    <td class="govuk-table__cell">This helps us to identify the number of distinct users accessing the site over time by tracking if you've visited before</td>
                    <td class="govuk-table__cell">1 year</td>
                </tr>
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">ai_authuser</td>
                    <td class="govuk-table__cell">This helps us to authenticated users and how they interact with the site</td>
                    <td class="govuk-table__cell">When you close your browser</td>
                </tr>
            </tbody>
        </table>
        <h2 class="govuk-heading-m">Cookie settings</h2>
        <p class="govuk-body">You can choose which cookies you’re happy for us to use.</p>
        <form method="post" name="frmCookies" novalidate="">
            <input type="hidden" name="returnUrl" value="@(TempData["returnUrl"] ?? this.HttpContext.Request.Headers["Referer"])" />
            <div class="govuk-form-group">
                <input type="hidden" name="redirectPath" value="@this.HttpContext.Request.Path" />
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                        <h3 class="govuk-heading-s">Do you want to accept Application Insights cookies?</h3>
                    </legend>
                    <div class="govuk-radios">
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" name="cookies" id="cookies-accept" type="radio" value="accept" @(canTrack ? "checked" : "")>
                            <label class="govuk-label govuk-radios__label" for="cookies-accept">
                                Yes
                            </label>
                        </div>
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" name="cookies" id="cookies-reject" type="radio" value="reject" @(!canTrack ? "checked" : "")>
                            <label class="govuk-label govuk-radios__label" for="cookies-reject">
                                No
                            </label>
                        </div>
                    </div>
                </fieldset>
            </div>
            <button type="submit" class="govuk-button" data-module="govuk-button">Save changes</button>
        </form>
    </div>
</div>
